<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gestionnaire de jours de cong√© - Calendrier interactif">
    <meta name="theme-color" content="#4a90e2">
    <title>Gestionnaire de Cong√©s</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-year-view.css">
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <!-- Modal de connexion/inscription -->
    <div id="authModal" class="modal active" style="display: block;">
        <div class="modal-content auth-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">üîê Connexion</h3>
                <button id="themeToggleAuth" class="theme-toggle" title="Changer le th√®me" aria-label="Changer le th√®me" style="position: relative; top: 0; right: 0;">üåô</button>
            </div>
            <div id="authError" class="error-message" style="display: none;"></div>
            
            <div class="auth-help-section" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 0.9em;">
                <p style="margin: 0 0 8px 0; color: #666;">üí° Si vous √™tes bloqu√© sur cette page, essayez de nettoyer les donn√©es locales :</p>
                <button id="clearAuthDataBtn" class="clear-data-btn" style="padding: 6px 12px; font-size: 0.85em; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">üßπ Nettoyer les donn√©es</button>
            </div>
            
            <div id="loginForm">
                <div class="auth-input-group">
                    <label for="loginEmail">Email :</label>
                    <input type="email" id="loginEmail" class="auth-input" placeholder="votre@email.com" required>
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">Mot de passe :</label>
                    <input type="password" id="loginPassword" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button id="loginBtn" class="save-btn">Se connecter</button>
                <p class="auth-switch">Pas encore de compte ? <a href="#" id="showSignup">S'inscrire</a></p>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div class="auth-input-group">
                    <label for="signupEmail">Email :</label>
                    <input type="email" id="signupEmail" class="auth-input" placeholder="votre@email.com" required>
                </div>
                <div class="auth-input-group">
                    <label for="signupPassword">Mot de passe :</label>
                    <input type="password" id="signupPassword" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    <small class="auth-hint">Minimum 6 caract√®res</small>
                </div>
                <div class="auth-input-group">
                    <label for="signupName">Nom :</label>
                    <input type="text" id="signupName" class="auth-input" placeholder="Votre nom" required>
                </div>
                <button id="signupBtn" class="save-btn">S'inscrire</button>
                <p class="auth-switch">D√©j√† un compte ? <a href="#" id="showLogin">Se connecter</a></p>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <div class="header-top">
                <h1>üìÖ Gestionnaire de Cong√©s</h1>
                <div class="header-right">
                    <div class="user-info">
                        <span id="userName" class="user-name"></span>
                        <span id="invitationsBadge" class="invitations-badge" style="display: none;" title="Vous avez des invitations en attente">üì®</span>
                    </div>
                    <button id="themeToggle" class="theme-toggle" title="Changer le th√®me" aria-label="Changer le th√®me">üåô</button>
                    <button id="helpBtn" class="help-btn" title="Aide">‚ùì</button>
                <button id="configBtn" class="config-btn" title="Configuration">‚öôÔ∏è</button>
                    <button id="logoutBtn" class="logout-btn" title="D√©connexion">‚èª</button>
                </div>
            </div>
            <div class="header-controls">
                <button id="prevMonth" class="nav-btn">‚óÄ</button>
                <h2 id="currentMonth"></h2>
                <button id="nextMonth" class="nav-btn">‚ñ∂</button>
                <button id="viewToggle" class="view-toggle-btn" title="Basculer entre vue semestrielle et annuelle">üìÖ</button>
                <button id="teamsBtn" class="teams-btn" title="G√©rer les √©quipes" style="display: none;">üë•</button>
                <button id="adminBtn" class="admin-btn" title="Administration" style="display: none;">‚öôÔ∏è Admin</button>
                <select id="teamSelect" class="team-select" title="S√©lectionner une √©quipe" style="display: none;">
                    <option value="">Mon calendrier</option>
                </select>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <span class="stat-label">Cong√©s pos√©s</span>
                <span class="stat-value" id="totalDays">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Jours restants</span>
                <span class="stat-value" id="remainingDays">0</span>
            </div>
        </div>

        <div class="help-hint" id="helpHint" style="display: none;">
            üí° Astuce : Maintenez <strong>Ctrl</strong> (ou <strong>Cmd</strong> sur Mac) et cliquez sur plusieurs jours pour les s√©lectionner en m√™me temps.
        </div>

        <div id="leaveQuotas" class="leave-quotas"></div>

        <div class="calendar-container">
            <div id="semesterView" class="semester-view">
                <div id="semesterCalendar" class="semester-calendar"></div>
            </div>
        </div>

        <!-- Modal de configuration -->
        <div id="configModal" class="modal">
            <div class="modal-content config-modal-content">
                <span class="close config-close">&times;</span>
                <h3>‚öôÔ∏è Configuration des Cong√©s</h3>

                <div class="config-section">
                    <h4>Quotas de Cong√©s par Ann√©e</h4>
                    <div class="year-selector">
                        <label for="configYearSelect">Ann√©e :</label>
                        <select id="configYearSelect" class="year-select">
                            <!-- Les options seront g√©n√©r√©es dynamiquement -->
                        </select>
                        <p class="config-hint">S√©lectionnez une ann√©e pour configurer les quotas de cong√©s pour cette ann√©e.</p>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Types de Cong√©s</h4>
                    <div id="leaveTypesConfig" class="leave-types-list"></div>
                    <button id="addLeaveTypeBtn" class="add-btn">+ Ajouter un type</button>
                </div>

                <!-- Section de d√©bogage - Masqu√©e en production mais conserv√©e pour le d√©veloppement -->
                <!-- Pour r√©activer cette section, d√©commentez le code ci-dessous -->
                <!--
                <div class="config-section">
                    <h4>üîß D√©bogage</h4>
                    <div class="debug-section">
                        <p class="config-hint">‚ö†Ô∏è Attention : Ces actions sont irr√©versibles</p>
                        <button id="resetLeavesBtn" class="debug-btn">üóëÔ∏è R√©initialiser tous les jours de cong√©</button>
                    </div>
                </div>
                -->

                <div class="config-section">
                    <h4>üóëÔ∏è Suppression de compte</h4>
                    <div class="debug-section">
                        <p class="config-hint">‚ö†Ô∏è Danger : Cette action supprimera d√©finitivement votre compte et toutes vos donn√©es</p>
                        <button id="deleteAccountBtn" class="delete-account-btn-full" title="Supprimer le compte">üóëÔ∏è Supprimer mon compte</button>
                    </div>
                </div>

                <div class="config-actions">
                    <button id="saveConfigBtn" class="save-btn">Enregistrer</button>
                    <button id="cancelConfigBtn" class="cancel-btn">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal de gestion des √©quipes -->
        <div id="teamsModal" class="modal">
            <div class="modal-content teams-modal-content">
                <span class="close teams-close">&times;</span>
                <h3>üë• Gestion des √âquipes</h3>
                
                <div class="teams-section">
                    <h4>Mes √©quipes</h4>
                    <div id="teamsList" class="teams-list"></div>
                    <button id="createTeamBtn" class="add-btn">+ Cr√©er une √©quipe</button>
                </div>

                <div id="teamDetailsSection" class="team-details-section" style="display: none;">
                    <h4 id="teamDetailsTitle"></h4>
                    <div id="teamMembersList" class="team-members-list"></div>
                    <div class="team-actions">
                        <button id="addMemberBtn" class="add-btn">+ Ajouter un membre</button>
                        <button id="deleteTeamBtn" class="delete-btn" style="display: none;">üóëÔ∏è Supprimer l'√©quipe</button>
                    </div>
                </div>

                <div id="createTeamSection" class="create-team-section" style="display: none;">
                    <h4>Cr√©er une nouvelle √©quipe</h4>
                    <div class="form-group">
                        <label for="teamNameInput">Nom de l'√©quipe :</label>
                        <input type="text" id="teamNameInput" class="form-input" placeholder="Ex: √âquipe D√©veloppement" required>
                    </div>
                    <div class="form-group">
                        <label for="teamDescriptionInput">Description (optionnel) :</label>
                        <textarea id="teamDescriptionInput" class="form-textarea" placeholder="Description de l'√©quipe..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button id="saveTeamBtn" class="save-btn">Cr√©er</button>
                        <button id="cancelCreateTeamBtn" class="cancel-btn">Annuler</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="closeTeamsModalBtn" class="cancel-btn">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal des invitations -->
        <div id="invitationsModal" class="modal">
            <div class="modal-content invitations-modal-content">
                <span class="close invitations-close">&times;</span>
                <h3>üì® Invitations en attente</h3>
                
                <div id="invitationsList" class="invitations-list">
                    <p class="no-invitations">Chargement...</p>
                </div>

                <div class="modal-actions">
                    <button id="closeInvitationsModalBtn" class="cancel-btn">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal d'administration -->
        <div id="adminModal" class="modal">
            <div class="modal-content admin-modal-content">
                <span class="close admin-close">&times;</span>
                <h3>‚öôÔ∏è Administration</h3>
                
                <!-- Onglets -->
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="users">üë• Utilisateurs</button>
                    <button class="admin-tab" data-tab="teams">üè¢ Groupes</button>
                    <button class="admin-tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
                    <button class="admin-tab" data-tab="stats">üìä Statistiques</button>
                    <button class="admin-tab" data-tab="audit">üìã Logs d'audit</button>
                </div>
                
                <!-- Section Utilisateurs -->
                <div id="adminUsersTab" class="admin-tab-content active">
                    <div class="admin-section-header">
                        <h4>Gestion des utilisateurs</h4>
                        <input type="text" id="adminUserSearch" placeholder="Rechercher un utilisateur..." class="admin-search">
                    </div>
                    <div id="adminUsersList" class="admin-list"></div>
                </div>
                
                <!-- Section Groupes -->
                <div id="adminTeamsTab" class="admin-tab-content">
                    <div class="admin-section-header">
                        <h4>Gestion des groupes</h4>
                    </div>
                    <div id="adminTeamsList" class="admin-list"></div>
                </div>
                
                <!-- Section Param√®tres -->
                <div id="adminSettingsTab" class="admin-tab-content">
                    <h4>Param√®tres par d√©faut</h4>
                    <div class="admin-settings-form">
                        <div class="admin-setting-item">
                            <label>Types de cong√©s par d√©faut (JSON) :</label>
                            <textarea id="defaultLeaveTypes" rows="10" placeholder='[{"id": "cong√©-pay√©", "name": "Cong√© Pay√©", "label": "CP", "color": "#4a90e2"}, ...]'></textarea>
                        </div>
                        <div class="admin-setting-item">
                            <label>Quotas par d√©faut (JSON) :</label>
                            <textarea id="defaultQuotas" rows="5" placeholder='{"cong√©-pay√©": 25, "rtt": 22, ...}'></textarea>
                        </div>
                        <div class="admin-setting-item">
                            <label>Pays par d√©faut :</label>
                            <select id="defaultCountry">
                                <option value="FR">France</option>
                                <option value="BE">Belgique</option>
                                <option value="CH">Suisse</option>
                                <option value="CA">Canada</option>
                            </select>
                        </div>
                        <button id="saveDefaultSettingsBtn" class="save-btn">Enregistrer</button>
                    </div>
                </div>
                
                <!-- Section Statistiques -->
                <div id="adminStatsTab" class="admin-tab-content">
                    <h4>Statistiques globales</h4>
                    <div id="adminStats" class="admin-stats-grid"></div>
                </div>
                
                <!-- Section Logs d'audit -->
                <div id="adminAuditTab" class="admin-tab-content">
                    <div class="admin-section-header">
                        <h4>Logs d'audit - √âv√©nements importants</h4>
                        <p class="admin-hint">Historique des actions administratives effectu√©es dans l'application</p>
                    </div>
                    <div id="adminAuditLogs" class="admin-audit-container"></div>
                </div>
            </div>
        </div>

        <!-- Modal d'aide -->
        <div id="helpModal" class="modal">
            <div class="modal-content help-modal-content">
                <span class="close help-close">&times;</span>
                <h3>‚ùì Aide - Guide d'utilisation</h3>
                
                <div class="help-section">
                    <h4>üìÖ Utilisation du calendrier</h4>
                    <ul class="help-list">
                        <li><strong>Ajouter un cong√© :</strong> Cliquez sur un jour dans le calendrier, choisissez la p√©riode (journ√©e compl√®te, matin ou apr√®s-midi) et s√©lectionnez le type de cong√©.</li>
                        <li><strong>S√©lection multiple :</strong> Maintenez <strong>Ctrl</strong> (ou <strong>Cmd</strong> sur Mac) et cliquez sur plusieurs jours pour les s√©lectionner, puis appliquez un cong√© √† tous en une fois.</li>
                        <li><strong>Modifier un cong√© :</strong> Cliquez sur un jour qui a d√©j√† un cong√© pour le modifier ou le supprimer.</li>
                        <li><strong>Navigation :</strong> Utilisez les fl√®ches ‚óÄ et ‚ñ∂ pour naviguer entre les semestres.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üé® Types de cong√©s</h4>
                    <ul class="help-list">
                        <li>Chaque type de cong√© peut avoir un <strong>quota</strong> (nombre de jours maximum par an).</li>
                        <li>Les types <strong>sans quota</strong> ou avec <strong>quota = 0</strong> ne sont <strong>pas comptabilis√©s</strong> dans les statistiques.</li>
                        <li>Vous pouvez personnaliser les types de cong√©s via la configuration (‚öôÔ∏è).</li>
                        <li>Les types par d√©faut sont : Cong√© Pay√©, RTT, Jours Hiver, Maladie, T√©l√©travail, Formation, Gr√®ve.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>‚è∞ Demi-journ√©es</h4>
                    <ul class="help-list">
                        <li>Vous pouvez poser des cong√©s pour le <strong>matin</strong> ou l'<strong>apr√®s-midi</strong> uniquement.</li>
                        <li>Une demi-journ√©e compte pour <strong>0.5 jour</strong> dans les statistiques.</li>
                        <li>Si vous posez une journ√©e compl√®te, les demi-journ√©es existantes sont automatiquement remplac√©es.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üìä Statistiques et quotas</h4>
                    <ul class="help-list">
                        <li><strong>Cong√©s pos√©s :</strong> Nombre total de jours de cong√© pos√©s (seulement pour les types avec quota > 0).</li>
                        <li><strong>Jours restants :</strong> Format "restants/total" - montre les jours restants sur le quota total.</li>
                        <li>Les cartes de quota affichent l'utilisation par type avec une barre de progression.</li>
                        <li>Les d√©passements sont affich√©s en rouge.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>‚öôÔ∏è Configuration</h4>
                    <ul class="help-list">
                        <li><strong>Types de cong√©s :</strong> Ajoutez, modifiez ou supprimez des types de cong√©s. Personnalisez les noms, labels et couleurs.</li>
                        <li><strong>Quotas :</strong> Configurez les quotas par type et par ann√©e. Laissez vide pour un quota illimit√©.</li>
                        <li><strong>D√©bogage :</strong> R√©initialisez tous vos jours de cong√© si n√©cessaire.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üîê Compte utilisateur</h4>
                    <ul class="help-list">
                        <li>Chaque utilisateur a son propre compte et ses propres donn√©es.</li>
                        <li>Vos donn√©es sont sauvegard√©es automatiquement dans le cloud (Supabase).</li>
                        <li>Vous pouvez vous d√©connecter (‚èª) ou supprimer votre compte depuis la configuration.</li>
                    </ul>
                </div>

                <div class="help-actions">
                    <button id="closeHelpBtn" class="save-btn">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal pour choisir le type de cong√© -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3>Choisir le type de cong√©</h3>
                <p id="selectedDate"></p>
                <p id="selectionInfo" class="selection-info" style="display: none;"></p>
                <p id="workingDaysInfo" class="working-days-info" style="display: none;"></p>
                
                <div class="half-day-selector">
                    <label>P√©riode :</label>
                    <div class="period-buttons">
                        <button id="fullDayBtn" class="period-btn active" data-period="full">Journ√©e compl√®te</button>
                        <button id="morningBtn" class="period-btn" data-period="morning">Matin</button>
                        <button id="afternoonBtn" class="period-btn" data-period="afternoon">Apr√®s-midi</button>
                    </div>
                </div>

                <div id="leaveTypes" class="leave-types">
                    <!-- Les boutons seront g√©n√©r√©s dynamiquement -->
                </div>
                <div class="modal-actions">
                    <button id="removeLeave" class="remove-btn">Supprimer</button>
                    <button id="openSelectionBtn" class="open-selection-btn" style="display: none;">Appliquer aux jours s√©lectionn√©s</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Configuration Supabase (doit √™tre charg√© en premier) -->
    <script src="config.js" onerror="console.warn('config.js non trouv√© - sera g√©n√©r√© par GitHub Actions lors du d√©ploiement')"></script>
    
    <!-- Biblioth√®ques externes -->
    <!-- date-fns sera charg√© dynamiquement par dateUtils.js si n√©cessaire -->
    
    <!-- Modules JavaScript (dans l'ordre de d√©pendance) -->
    <script src="js/supabase-init.js"></script>
    <script src="js/dateUtils.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/holidays.js"></script>
    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/teams.js"></script>
    <script src="js/teamsUI.js"></script>
    <script src="js/invitationsUI.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/adminUI.js"></script>
    <script src="js/calendar.js"></script>
    <script src="js/yearViewPresence.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/config.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/leaveManager.js"></script>
    <!-- Service Worker Registration -->
    <script src="js/pwa.js"></script>
</body>
</html>

